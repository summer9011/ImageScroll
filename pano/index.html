<!DOCTYPE html>
<html>
<head>
    <title>krpano iPhone</title>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
</head>
<body>
    <!-- Pano -->
    <div id="krpanoDIV" style="position: absolute; left: 0px; top: 0px; width: 100%; height: 100%"></div>
    <script src="./embedpano.js"></script>
    <script>
        //浏览器版本判断
        if (createPanoViewer().isHTML5possible()) {
            embedpano({xml: "./default.xml", swf:"./krpano.swf", id:"krpanoSWFObject", html5:"only", target: "krpanoDIV", passQueryParameters: true, onready: krpanoReady, onerror: krpanoError});
        } else {
            console.log('浏览器不支持HTML5');
        }
        
        //全景Ready
        function krpanoReady(krpano) {
            //全景Completed
            krpano.set("events.onloadcomplete", function() {
                console.log("加载完成");
            });
            
            //全景MouseUp
            krpano.set("events.onmouseup", function() {
                console.log("鼠标点击");
            });
            
            console.log("准备");
            krpano.call("loadpano('./weingut/tour.xml', null, MERGE,BLEND(0));");
        }
        
        //全景错误
        function krpanoError(error) {
            console.log("错误：" + error);
        }
    </script>
    
    <!-- OC-JS-Bridge -->
    <script>
	window.onerror = function(err) {
            log('window.onerror: ' + err);
	};
	
	function connectWebViewJavascriptBridge(callback) {
            if (window.WebViewJavascriptBridge) {
                callback(WebViewJavascriptBridge);
            } else {
                document.addEventListener('WebViewJavascriptBridgeReady', function() {
                    callback(WebViewJavascriptBridge);
                }, false);
            }
	}
	
	connectWebViewJavascriptBridge(function(bridge) {
            var uniqueId = 1;
            function log(message, data) {
                var log = document.getElementById('log');
                var el = document.createElement('div');
                el.className = 'logLine';
                el.innerHTML = uniqueId++ + '. ' + message + ':<br/>' + JSON.stringify(data);
                if (log.children.length) { log.insertBefore(el, log.children[0]); }
                else { log.appendChild(el); }
            }
            bridge.init(function(message, responseCallback) {
                log('JS got a message', message);
                var data = { 'Javascript Responds':'Wee!' };
                log('JS responding with', data);
                responseCallback(data);
            });

            bridge.registerHandler('testJavascriptHandler', function(data, responseCallback) {
                log('ObjC called testJavascriptHandler with', data);
                var responseData = { 'Javascript Says':'Right back atcha!' };
                log('JS responding with', responseData);
                responseCallback(responseData);
            });

            var button = document.getElementById('buttons').appendChild(document.createElement('button'));
            button.innerHTML = 'Send message to ObjC';
            button.onclick = function(e) {
                e.preventDefault();
                var data = 'Hello from JS button';
                log('JS sending message', data);
                bridge.send(data, function(responseData) {
                    log('JS got response', responseData);
                });
            };

            document.body.appendChild(document.createElement('br'));

            var callbackButton = document.getElementById('buttons').appendChild(document.createElement('button'));
            callbackButton.innerHTML = 'Fire testObjcCallback';
            callbackButton.onclick = function(e) {
                e.preventDefault();
                log('JS calling handler "testObjcCallback"');
                bridge.callHandler('testObjcCallback', {'foo': 'bar'}, function(response) {
                    log('JS got response', response);
                });
            };
	});
    </script>
    <div id='buttons'></div> <div id='log'></div>
</body>
</html>
