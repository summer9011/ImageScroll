<!DOCTYPE html>
<html>
<head>
    <title>krpano iPhone</title>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
</head>
<body>
    <!-- Pano -->
    <div id="krpanoDIV" style="position: absolute; left: 0px; top: 0px; width: 100%; height: 100%"></div>
    <script src="./embedpano.js"></script>
    <script>
        var krpano = null;
        var currentSceneName = null;
        
        //浏览器版本判断
        if (createPanoViewer().isHTML5possible()) {
            embedpano({xml: "./default.xml", swf:"./krpano.swf", id:"krpanoSWFObject", html5:"only", target: "krpanoDIV", passQueryParameters: true, onready: krpanoReady, onerror: krpanoError});
        } else {
            console.log('浏览器不支持HTML5');
        }
        
        //全景Ready
        function krpanoReady(pano) {
            krpano = pano;
            
            //全景Completed
            krpano.set("events.onloadcomplete", function() {
                location.href = "#complete";
                
                getSceneData(currentSceneName);
            });
            
            //全景MouseUp
            krpano.set("events.onmouseup", function() {
                location.href = "#mouseup";
//                location.href = "#x"+krpano.get("mouse.x")+"y"+krpano.get("mouse.y");
            });
            
            location.href = "#ready";
        }
        
        //全景错误
        function krpanoError() {
            location.href = "#error";
        }
        
        //加载pano, 默认场景为0
        function goPano(panoName) {
            krpano.call("loadpano('" + panoName + "', null, MERGE,BLEND(0.5));");
        }
        
        //加载场景
        function goScene(sceneName) {
            currentSceneName = sceneName;
            krpano.call("loadscene("+sceneName+", null, MERGE);");
        }
        
        //获取场景相关数据
        function getSceneData(sceneName) {
            var jsonStr = krpano.get("data["+sceneName+"_data].content");
            var jsonObj = eval('(' + jsonStr + ')');
            
            //在全景中增加事件
            if(jsonStr !== null) {
                for(var index in jsonObj) {
                    if(jsonObj[index].action == "goScene") {
                        var hotspotName = sceneName+"_hotspot"+index;
                        
                        krpano.call("addhotspot("+hotspotName+")");
                        
                        krpano.set("hotspot["+hotspotName+"].url", "./hotspot.png");
                        krpano.set("hotspot["+hotspotName+"].zoom", true);
                        krpano.set("hotspot["+hotspotName+"].scale", 0.5);
                        krpano.set("hotspot["+hotspotName+"].ath", jsonObj[index].h);
                        krpano.set("hotspot["+hotspotName+"].atv", jsonObj[index].v);
                        krpano.set("hotspot["+hotspotName+"].onclick", "js(goScene("+jsonObj[index].sceneName+"));");
                    }
                    
                    if(jsonObj[index].action == "showPic") {
                        addShowPicHotspot(jsonObj[index]);
                    }
                }
            }
        }
        
        //添加进入下一场景的spot
        function addGoSceneHotspot(obj) {
            
        }
        
        //添加显示图片的spot
        function addShowPicHotspot(obj) {
            
        }
        
    </script>
</body>
</html>
